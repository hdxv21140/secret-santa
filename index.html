<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Secret Santa ‚Äì Tirage au sort (sans pub)</title>
  <meta name="description" content="Mini webapp ultra casual pour organiser un Secret Santa sans pub, 100% en local." />
  <style>
    :root {
      --bg: #faf7f2;
      --panel: #ffffff;
      --ink: #262626;
      --muted: #6b7280;
      --accent: #ff6b6b; /* bonbon */
      --accent-2: #ffd166; /* sabl√© */
      --ok: #10b981;
      --ring: #e5e7eb;
      --shadow: 0 10px 20px rgba(0,0,0,.06), 0 2px 6px rgba(0,0,0,.04);
      --radius: 20px;
    }
    html, body {height: 100%;}
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      background: radial-gradient(1200px 800px at 80% -20%, #ffe9e9, transparent 50%),
                  radial-gradient(900px 600px at -10% 110%, #fff5d6, transparent 50%),
                  var(--bg);
      color: var(--ink);
    }
    .container {
      max-width: 980px; margin: 0 auto; padding: 24px; display: grid; gap: 16px;
    }
    header {
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand .logo { font-size: 28px; }
    .brand h1 { font-size: 20px; margin: 0; letter-spacing: .2px; }
    .tagline { color: var(--muted); font-size: 14px; }

    .panel { background: var(--panel); box-shadow: var(--shadow); border-radius: var(--radius); padding: 20px; }

    .grid { display: grid; gap: 12px; }
    .grid.two { grid-template-columns: 1fr; }
    @media (min-width: 720px) { .grid.two { grid-template-columns: 1fr 1fr; } }

    label { font-weight: 600; font-size: 14px; }
    input[type="text"], input[type="email"], input[type="number"], input[type="date"], textarea {
      width: 100%; box-sizing: border-box; padding: 12px 14px; border-radius: 12px; border: 1px solid var(--ring); background: #fff; color: var(--ink);
      outline: none; transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus, textarea:focus { box-shadow: 0 0 0 4px rgba(255,107,107,.15); border-color: var(--accent); }

    .btn { appearance: none; border: none; border-radius: 14px; padding: 12px 16px; font-weight: 700; cursor: pointer; box-shadow: var(--shadow);
      background: var(--ink); color: #fff; transition: transform .04s ease, filter .15s ease; }
    .btn:hover { filter: brightness(1.03); }
    .btn:active { transform: translateY(1px); }
    .btn.ghost { background: #fff; color: var(--ink); border: 1px solid var(--ring); }
    .btn.accent { background: linear-gradient(135deg, var(--accent), #ff8c6b); }
    .btn.ok { background: linear-gradient(135deg, var(--ok), #34d399); }
    .btn.warn { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: #111; }

    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .chip { background: #fff; border: 1px dashed var(--ring); padding: 8px 12px; border-radius: 999px; font-size: 13px; color: var(--muted); }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #f0f0f0; text-align: left; }
    th { font-size: 13px; color: var(--muted); font-weight: 600; }

    .muted { color: var(--muted); }
    .hint { font-size: 13px; color: var(--muted); }
    .center { text-align: center; }

    .reveal {
      display: grid; place-items: center; gap: 12px; padding: 28px; border: 2px dashed #ffd4d4; border-radius: 16px; background: #fff9f9;
    }
    .big { font-size: 40px; font-weight: 800; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .footer { text-align: center; font-size: 12px; color: var(--muted); padding: 8px; }
    .divider { height: 1px; background: #f1f1f1; margin: 12px 0; }
    .spacer { height: 8px; }

    .pill { padding: 6px 10px; border-radius: 999px; background: #fff; border: 1px solid var(--ring); font-size: 12px; }
    .wrap { word-break: break-word; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">üéÅ</div>
        <div>
          <h1>Secret Santa ‚Ä¢ Tirage sans pub</h1>
          <div class="tagline">Ultra casual ‚Ä¢ 100% en local ‚Ä¢ Aucun suivi</div>
        </div>
      </div>
      <div class="row">
        <button class="btn ghost" id="btnNew">Nouveau tirage</button>
        <a class="btn accent" href="#" id="btnHelp">Comment √ßa marche ?</a>
      </div>
    </header>

    <div id="organizer" class="panel">
      <div class="grid two">
        <div>
          <label for="title">Nom de l'√©v√©nement (optionnel)</label>
          <input id="title" type="text" placeholder="Secret Santa du bureau" />
        </div>
        <div class="grid">
          <div class="row">
            <div style="flex:1">
              <label for="budget">Budget (optionnel)</label>
              <input id="budget" type="text" placeholder="15 ‚Ç¨" />
            </div>
            <div style="flex:1">
              <label for="date">Date d'√©change (optionnel)</label>
              <input id="date" type="date" />
            </div>
          </div>
        </div>
      </div>

      <div class="spacer"></div>
      <label>Participants</label>
      <div class="hint">Ajoute au moins 2 pr√©noms. Les emails sont facultatifs (juste pour t'aider √† partager).</div>

      <div id="list" class="grid" style="margin-top:8px"></div>
      <div class="row">
        <button class="btn ghost" id="add">+ Ajouter un participant</button>
        <button class="btn" id="paste">Coller des pr√©noms</button>
        <span class="chip">Astuce : ‚ÄúAlice, Bob, Chlo√©‚Äù ou une liste multi-ligne</span>
      </div>

      <div class="divider"></div>
      <div class="row">
        <button class="btn ok" id="draw">Tirer au sort</button>
        <button class="btn warn" id="shuffle">Re-m√©langer</button>
        <span class="hint">Pas d'auto-attribution. Tirage instantan√©, en local.</span>
      </div>

      <div id="results" class="grid" style="display:none">
        <div class="divider"></div>
        <h3 style="margin:0">Liens individuels √† partager</h3>
        <div class="hint">Chaque lien ne r√©v√®le que la personne √† qui offrir. Il contient les infos cod√©es dans l'URL (#hash), sans serveur.</div>
        <table id="table"></table>
        <div class="row">
          <button class="btn ghost" id="copyAll">Copier tous les liens</button>
          <button class="btn ghost" id="exportCsv">Exporter CSV</button>
        </div>
      </div>
    </div>

    <div id="participant" class="panel" style="display:none">
      <div id="pMeta" class="row" style="justify-content: space-between; align-items: start;">
        <div class="row" style="gap:8px; flex-wrap: wrap;">
          <span id="pEvent" class="pill"></span>
          <span id="pBudget" class="pill"></span>
          <span id="pDate" class="pill"></span>
        </div>
        <a class="btn ghost" id="pBack" href="#">Je suis l'organisateur¬∑rice</a>
      </div>
      <div class="spacer"></div>
      <div class="reveal">
        <div class="muted">Coucou <span id="pName" class="mono"></span> üëã</div>
        <button class="btn accent" id="btnReveal">Afficher √† qui tu offres</button>
        <div id="giftTo" class="big" style="display:none"></div>
        <div id="meta" class="hint"></div>
      </div>
      <div class="spacer"></div>
      <div class="hint center">Garde ce lien secret ; il fonctionne aussi hors connexion apr√®s ouverture ‚úÖ</div>
    </div>

    <div id="help" class="panel" style="display:none">
      <h3>Mode d'emploi</h3>
      <ol>
        <li>Ajoute les pr√©noms (emails facultatifs).</li>
        <li>Clique <strong>Tirer au sort</strong>. L'appli cr√©e un tirage <em>sans auto-attribution</em>.</li>
        <li>Copie les <strong>liens individuels</strong> et envoie-les aux participant¬∑e¬∑s. Chaque lien r√©v√®le seulement l'information de la personne concern√©e.</li>
        <li>Tout se fait <strong>en local</strong>. Aucune donn√©e n'est envoy√©e nulle part. Pas de pub, pas de traqueur.</li>
      </ol>
      <div class="hint">Besoin d'exclusions / couples ? Version simple ici ; √©cris-moi si tu veux une version avanc√©e.</div>
    </div>

    <div class="footer">Fait avec ‚ù§Ô∏è pour des f√™tes sereines. Code 100% c√¥t√© client.</div>
  </div>

<script>
(function(){
  const preloadedParticipants = [
    {name: "Hubert", email: "h2marliave@gmail.com"},
    {name: "Alexandre", email: "alexandre.giuglaris@gmail.com"},
    {name: "Henri", email: "hdemarliave@gmail.com"},
    {name: "Louis", email: "louidemar@gmail.com"},
    {name: "Caroline", email: "tillieuxcaroline@gmail.com"},
    {name: "Marie-Caroline", email: "mcdemarliave@gmail.com"},
    {name: "Constance", email: "constancedemarliave@gmail.com"},
    {name: "Lucile", email: "luciledemarliave@gmail.com"}
  ];

  const qs = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));

  const els = {
    organizer: qs('#organizer'),
    participant: qs('#participant'),
    list: qs('#list'),
    add: qs('#add'),
    paste: qs('#paste'),
    draw: qs('#draw'),
    shuffle: qs('#shuffle'),
    results: qs('#results'),
    table: qs('#table'),
    copyAll: qs('#copyAll'),
    exportCsv: qs('#exportCsv'),
    btnNew: qs('#btnNew'),
    btnHelp: qs('#btnHelp'),
    help: qs('#help'),
    title: qs('#title'),
    budget: qs('#budget'),
    date: qs('#date'),
    // participant view
    pEvent: qs('#pEvent'), pBudget: qs('#pBudget'), pDate: qs('#pDate'),
    pName: qs('#pName'), giftTo: qs('#giftTo'), btnReveal: qs('#btnReveal'), pBack: qs('#pBack'), meta: qs('#meta')
  };

  const state = {
    participants: [], // [{name, email}]
    pairs: [], // [{giver, receiver}]
    tokens: {}, // name -> token
    payload: null,
  };

  function addRow(name = '', email = ''){
    const row = document.createElement('div');
    row.className = 'row';
    row.style.alignItems = 'stretch';
    row.innerHTML = `
      <input type="text" placeholder="Pr√©nom" value="${escapeHtml(name)}" style="flex:1"/>
      <input type="email" placeholder="email (optionnel)" value="${escapeHtml(email)}" style="flex:1"/>
      <button class="btn ghost" title="Supprimer">‚úï</button>
    `;
    const [nameInput, emailInput, delBtn] = row.children;
    delBtn.addEventListener('click', ()=>{ row.remove(); refreshState(); saveLocal(); });
    nameInput.addEventListener('input', ()=>{ refreshState(); saveLocal(); });
    emailInput.addEventListener('input', ()=>{ refreshState(); saveLocal(); });
    els.list.appendChild(row);
    refreshState();
  }

  function refreshState(){
    state.participants = qsa('#list .row').map(r=>({name:r.children[0].value.trim(), email:r.children[1].value.trim()})).filter(p=>p.name);
    els.draw.disabled = state.participants.length < 2;
    els.shuffle.disabled = state.pairs.length === 0;
  }

  function parsePaste(text){
    const candidates = text.split(/[\\n,;]+/).map(s=>s.trim()).filter(Boolean);
    return candidates.map(n=>{
      const parts = n.split(/\\s+/);
      if(parts.length >= 2 && parts[parts.length-1].includes("@")){
        const email = parts.pop();
        return {name: parts.join(" "), email};
      }
      return {name:n, email:''};
    });
  }

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }

  function derangement(names){
    const n = names.length;
    if(n===1) return null;
    let rec = shuffle(names);
    for(let i=0;i<n;i++){
      if(rec[i] === names[i]){
        const j = (i+1)%n; [rec[i], rec[j]] = [rec[j], rec[i]];
      }
    }
    for(let i=0;i<n;i++){ if(rec[i] === names[i]) return derangement(names); }
    return rec;
  }

  function generate(){
    const names = state.participants.map(p=>p.name);
    if(names.length < 2){ alert('Ajoute au moins 2 participants.'); return; }
    const rec = derangement(names);
    if(!rec){ alert('Impossible avec 1 participant.'); return; }
    state.pairs = names.map((giver, i)=>({giver, receiver: rec[i]}));
    state.tokens = {};
    for(const {giver} of state.pairs){ state.tokens[giver] = token(10); }
    buildPayload();
    renderTable();
    els.results.style.display = '';
    els.shuffle.disabled = false;
    saveLocal();
  }

  function rebuildFromPayload(payloadStr, tokenKey){
    try{
      const data = JSON.parse(decodeURIComponent(atob(payloadStr)));
      const list = data.list || [];
      const found = list.find(x=>x.t === tokenKey);
      if(!found) return null;
      return { meta: data, me: found.g, to: found.r };
    }catch(e){ return null; }
  }

  function buildPayload(){
    const meta = {
      ev: els.title.value.trim() || '',
      bu: els.budget.value.trim() || '',
      dt: els.date.value || '',
      list: state.pairs.map(pr=>({ t: state.tokens[pr.giver], g: pr.giver, r: pr.receiver }))
    };
    state.payload = btoa(encodeURIComponent(JSON.stringify(meta)));
  }

  function makeLink(token){
    const base = location.href.split('#')[0];
    return `${base}#d=${state.payload}&t=${token}`;
  }

  function renderTable(){
    els.table.innerHTML = '';
    const head = document.createElement('tr');
    head.innerHTML = '<th>Participant</th><th>Email</th><th>Lien individuel</th><th></th>';
    els.table.appendChild(head);

    const rows = state.participants.map(p=>{
      const t = state.tokens[p.name];
      const link = makeLink(t);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="wrap">${escapeHtml(p.name)}</td>
        <td class="wrap">${escapeHtml(p.email||'')}</td>
        <td class="wrap"><span class="mono">${escapeHtml(link)}</span></td>
        <td><button class="btn ghost" data-link>Copier</button></td>
      `;
      tr.querySelector('[data-link]').addEventListener('click', ()=>copy(link, `Lien copi√© pour ${p.name} ‚ú®`));
      return tr;
    });

    rows.forEach(r=>els.table.appendChild(r));
  }

  function copyAll(){
    if(!state.pairs.length){ alert('Rien √† copier.'); return; }
    const lines = state.pairs.map(pr=>{
      const email = (state.participants.find(p=>p.name===pr.giver)||{}).email || '';
      return `${pr.giver}\t${email}\t${makeLink(state.tokens[pr.giver])}`;
    }).join('\\n');
    copy(lines, 'Liens copi√©s dans le presse-papiers');
  }

  function exportCsv(){
    if(!state.pairs.length){ alert('Rien √† exporter.'); return; }
    const rows = [['participant','email','lien']].concat(state.pairs.map(pr=>{
      const email = (state.participants.find(p=>p.name===pr.giver)||{}).email || '';
      return [pr.giver, email, makeLink(state.tokens[pr.giver])];
    }));
    const csv = rows.map(r=>r.map(s=>`"${String(s).replace(/"/g,'""')}"`).join(',')).join('\\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'secret-santa-liens.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  function token(n){
    const dict='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let out='';
    for(let i=0;i<n;i++) out += dict[Math.floor(Math.random()*dict.length)];
    return out;
  }

  function escapeHtml(str=''){ return str.replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  async function copy(text, okMsg){
    try{ await navigator.clipboard.writeText(text); toast(okMsg||'Copi√© !'); }
    catch(e){ prompt('Copie manuelle : Ctrl+C puis Entr√©e', text); }
  }

  let toastT=null; function toast(msg){
    let el = document.querySelector('#toast');
    if(!el){ el=document.createElement('div'); el.id='toast'; document.body.appendChild(el);
      el.style.position='fixed'; el.style.left='50%'; el.style.bottom='24px'; el.style.transform='translateX(-50%)';
      el.style.background='#111'; el.style.color='#fff'; el.style.padding='10px 14px'; el.style.borderRadius='999px'; el.style.boxShadow='var(--shadow)';
      el.style.fontSize='14px'; el.style.zIndex='9999';
    }
    el.textContent=msg; el.style.opacity='1';
    clearTimeout(toastT); toastT=setTimeout(()=>{ el.style.transition='opacity .4s'; el.style.opacity='0'; }, 1500);
  }

  function saveLocal(){
    const data = {
      title: els.title.value, budget: els.budget.value, date: els.date.value,
      participants: state.participants, pairs: state.pairs, tokens: state.tokens, payload: state.payload
    };
    localStorage.setItem('ssanta', JSON.stringify(data));
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem('ssanta'); 
      if(raw){
        const d = JSON.parse(raw);
        els.title.value = d.title||''; els.budget.value=d.budget||''; els.date.value=d.date||'';
        els.list.innerHTML='';
        (d.participants||[]).forEach(p=>addRow(p.name, p.email));
        if((d.pairs||[]).length){
          state.pairs = d.pairs; state.tokens = d.tokens||{}; state.payload = d.payload||null;
          els.results.style.display=''; renderTable();
        }
        return;
      }
    }catch(e){}
    // If nothing saved, preload your participants
    els.list.innerHTML='';
    preloadedParticipants.forEach(p=>addRow(p.name, p.email));
    saveLocal();
  }

  function clearAll(){
    els.title.value = els.budget.value = ''; els.date.value='';
    els.list.innerHTML=''; state.participants=[]; state.pairs=[]; state.tokens={}; state.payload=null;
    els.results.style.display='none'; addRow(); addRow(); saveLocal();
  }

  function handleHash(){
    const hash = new URLSearchParams(location.hash.slice(1));
    const d = hash.get('d'); const t = hash.get('t');
    if(d && t){
      els.organizer.style.display='none'; els.participant.style.display=''; els.help.style.display='none';
      const parsed = rebuildFromPayload(d, t);
      if(!parsed){ document.querySelector('#giftTo').textContent='Lien invalide'; document.querySelector('#btnReveal').style.display='none'; return; }
      const { meta, me, to } = parsed;
      if(meta.ev){ els.pEvent.textContent = 'üéâ ' + meta.ev; els.pEvent.style.display=''; } else els.pEvent.style.display='none';
      if(meta.bu){ els.pBudget.textContent = 'üí∂ Budget : ' + meta.bu; els.pBudget.style.display=''; } else els.pBudget.style.display='none';
      if(meta.dt){ els.pDate.textContent = 'üìÖ √âchange : ' + meta.dt; els.pDate.style.display=''; } else els.pDate.style.display='none';
      els.pName.textContent = me;
      els.meta.textContent = '';
      els.btnReveal.onclick = ()=>{ els.giftTo.style.display=''; els.giftTo.textContent = 'üéÅ Tu offres √† ' + to + ' !'; els.btnReveal.style.display='none'; };
      return;
    }
    els.organizer.style.display=''; els.participant.style.display='none';
  }

  // Hook up events
  document.addEventListener('click', (e)=>{
    if(e.target.id === 'add') addRow();
  });
  // The original 'paste' button behavior
  document.addEventListener('click', async (e)=>{
    if(e.target && e.target.id === 'paste'){
      const txt = (await navigator.clipboard.readText().catch(()=>'')) || '';
      const list = txt ? parsePaste(txt) : [];
      if(!list.length){ alert('Copie une liste (ligne par ligne ou s√©par√©e par des virgules) puis r√©essaie.'); return; }
      list.forEach(p=>addRow(p.name, p.email));
      saveLocal();
    }
  });
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id === 'draw') generate();
    if(e.target && e.target.id === 'shuffle') generate();
    if(e.target && e.target.id === 'copyAll') copyAll();
    if(e.target && e.target.id === 'exportCsv') exportCsv();
    if(e.target && e.target.id === 'btnNew') clearAll();
    if(e.target && e.target.id === 'btnHelp'){ e.preventDefault(); els.help.style.display = els.help.style.display ? '' : 'none'; }
    if(e.target && e.target.id === 'pBack'){ location.hash = ''; handleHash(); }
  });

  // Init
  addRow(); addRow();
  loadLocal();
  handleHash();
  window.addEventListener('hashchange', handleHash);
})();
</script>
</body>
</html>
