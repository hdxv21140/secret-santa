<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Secret Santa ‚Ä¢ No√´l üéÑ</title>
  <meta name="description" content="Secret Santa 100% local, sans pub ni serveur, avec exclusions et reveal anim√©." />
  <style>
    :root{
      --bg:#0b1c13; --panel:#10281b; --panel2:#0f2217; --ink:#f7faf7; --muted:#b7c7bb;
      --ring:#234732; --accent:#e11d48; --gold:#facc15; --ok:#22c55e;
      --shadow:0 10px 24px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.40);
      --r:18px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(800px 500px at 10% 0%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(900px 600px at 100% 100%, rgba(255,255,255,.05), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }
    /* neige */
    .snowflake{position:fixed; top:-10px; color:rgba(255,255,255,.85); user-select:none; pointer-events:none; animation:fall linear infinite; z-index:1; filter:drop-shadow(0 2px 2px rgba(0,0,0,.4))}
    @keyframes fall{0%{transform:translateY(-10vh) translateX(0) rotate(0);opacity:0} 10%{opacity:1} 100%{transform:translateY(110vh) translateX(var(--x,0)) rotate(360deg);opacity:.95}}
    .container{position:relative; z-index:2; max-width:980px; margin:0 auto; padding:24px; display:grid; gap:16px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{font-size:28px}
    h1{margin:0; font-size:22px}
    .tagline{color:var(--muted); font-size:13px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--ring); border-radius:var(--r); box-shadow:var(--shadow); padding:18px}
    .grid{display:grid; gap:12px}
    .grid.two{grid-template-columns:1fr} @media(min-width:760px){.grid.two{grid-template-columns:1fr 1fr}}
    label{font-weight:700; font-size:14px}
    input[type="text"],input[type="email"],input[type="date"]{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--ring); background:#0b1f16; color:var(--ink); outline:none
    }
    input:focus{box-shadow:0 0 0 4px rgba(34,197,94,.18); border-color:#3aa466}
    .btn{border:none; border-radius:14px; padding:12px 16px; font-weight:800; cursor:pointer; box-shadow:var(--shadow); background:#133021; color:#fff; transition:.04s transform}
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:transparent; border:1px solid var(--ring)}
    .btn.ok{background:linear-gradient(135deg,#22c55e,#16a34a)}
    .btn.accent{background:linear-gradient(135deg,var(--accent),#f43f5e)}
    .btn.gold{background:linear-gradient(135deg,#f59e0b,var(--gold)); color:#111}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .hint{font-size:13px; color:var(--muted)}
    .divider{height:1px; background:#153523; margin:12px 0; opacity:.9}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 8px; border-bottom:1px solid #183b27; text-align:left}
    th{font-size:12px; color:#c9d9cd; letter-spacing:.2px; text-transform:uppercase}
    .pill{padding:6px 10px; border-radius:999px; background:#0b1f16; border:1px solid var(--ring); font-size:12px}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #4d1d1d; background:linear-gradient(180deg,#451a1a,#3b0d0d); color:#fecaca; font-size:12px}
    .footer{text-align:center; font-size:12px; color:#c6d5c8; padding:6px; opacity:.8}

    /* Intro participant + slot machine */
    .intro{display:grid; gap:14px; text-align:center; padding:22px; background:linear-gradient(180deg,rgba(16,40,27,.7),rgba(15,34,23,.9)); border:1px solid var(--ring); border-radius:var(--r)}
    .slot{display:grid; place-items:center; gap:10px; padding:20px; border:2px dashed #2b5d40; border-radius:16px; background:#0b1f16}
    .slot-name{font-size:42px; font-weight:900; letter-spacing:.4px; min-height:48px}
    .slot-strip{display:flex; gap:8px; opacity:.85; flex-wrap:wrap; justify-content:center}
    .slot-chip{padding:6px 10px; border-radius:999px; background:#0f2217; border:1px solid #1e4130; font-size:12px}
    .confetti{position:fixed; left:0; top:0; width:100%; height:0; pointer-events:none; overflow:visible; z-index:9}
    .confetti i{position:absolute; width:8px; height:14px; background:var(--gold); transform:rotate(20deg); animation:drop 1.2s ease-out forwards}
    @keyframes drop{to{transform:translateY(80vh) rotate(360deg)}}
  </style>
</head>
<body>
  <!-- neige -->
  <div id="snow"></div>

  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">üéÑ</div>
        <div>
          <h1>Secret Santa ‚Ä¢ Sp√©cial No√´l</h1>
          <div class="tagline">Magique, sans pub & 100% local ‚ú®</div>
        </div>
      </div>
      <div class="row">
        <button class="btn ghost" id="btnNew">Nouveau tirage</button>
        <a class="btn gold" href="#" id="btnHelp">Aide</a>
      </div>
    </header>

    <!-- ORGANISATEUR -->
    <div id="organizer" class="panel">
      <div class="grid two">
        <div>
          <label for="title">Nom de l'√©v√©nement</label>
          <input id="title" type="text" placeholder="Secret Santa de No√´l" />
        </div>
        <div class="grid">
          <div class="row">
            <div style="flex:1">
              <label for="budget">Budget</label>
              <input id="budget" type="text" placeholder="15‚Äì20 ‚Ç¨" />
            </div>
            <div style="flex:1">
              <label for="date">Date d'√©change</label>
              <input id="date" type="date" />
            </div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div>
          <label>Participants</label>
          <div class="hint">Tu peux coller <em>pr√©nom email</em> sur chaque ligne (email facultatif).</div>
        </div>
        <div class="row">
          <button class="btn ghost" id="add">+ Ajouter</button>
          <button class="btn" id="paste">Coller des pr√©noms</button>
        </div>
      </div>

      <div id="list" class="grid" style="margin-top:8px"></div>

      <div class="divider"></div>

      <div class="grid">
        <div class="row"><span class="pill">üéØ R√®gles d'exclusion</span></div>
        <div id="rules" class="row"></div>
        <div class="hint">Ces paires ne pourront ni s'offrir, ni se recevoir.</div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn ok" id="draw">Tirer au sort</button>
        <button class="btn accent" id="shuffle">Re-m√©langer</button>
        <span class="hint">Pas d'auto-attribution ‚Ä¢ Respecte les exclusions ‚Ä¢ Local only</span>
      </div>

      <div id="results" class="grid" style="display:none">
        <div class="divider"></div>
        <h3 style="margin:0">Liens individuels √† partager</h3>
        <div class="hint">Chaque lien ne r√©v√®le que la cible, tout est encod√© dans le <span class="pill">#hash</span>.</div>
        <table id="table"></table>
        <div class="row">
          <button class="btn ghost" id="copyAll">Copier tous les liens</button>
          <button class="btn ghost" id="exportCsv">Exporter CSV</button>
        </div>
      </div>
    </div>

    <!-- PARTICIPANT -->
    <div id="participant" class="panel" style="display:none">
      <div class="row" style="justify-content:space-between; align-items:start;">
        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <span id="pEvent" class="pill"></span>
          <span id="pBudget" class="pill"></span>
          <span id="pDate" class="pill"></span>
        </div>
        <a class="btn ghost" id="pBack" href="#">Je suis l'organisateur¬∑rice</a>
      </div>

      <!-- Intro -->
      <div id="intro" class="intro">
        <h2>üéÅ Bienvenue au Secret Santa !</h2>
        <p>Cette √©dition a √©t√© imagin√©e et organis√©e par <strong>Henri</strong>.</p>
        <p class="hint">Tout est priv√©, sans pub, et fonctionne directement dans ton navigateur.</p>
        <div class="row" style="justify-content:center">
          <button class="btn gold" id="startReveal">Voir mon tirage</button>
        </div>
      </div>

      <!-- Slot-machine -->
      <div id="slotStage" class="slot" style="display:none">
        <div class="slot-name" id="slotName">‚Äî</div>
        <div class="slot-strip" id="slotStrip"></div>
        <div class="row" style="justify-content:center; margin-top:6px">
          <button class="btn gold" id="spinBtn">Lancer le d√©filement üé∞</button>
        </div>
      </div>

      <!-- R√©sultat -->
      <div id="final" class="intro" style="display:none">
        <h2>üéÖ Ton Secret Santa</h2>
        <div id="giftTo" style="font-size:38px; font-weight:900; margin-top:6px"></div>
        <div id="meta" class="hint" style="margin-top:6px"></div>
      </div>

      <div class="hint" style="text-align:center;">Garde ce lien secret ; il fonctionne aussi hors connexion apr√®s ouverture ‚úÖ</div>
    </div>

    <div id="help" class="panel" style="display:none">
      <h3>Mode d'emploi</h3>
      <ol>
        <li>Ajoute les pr√©noms (emails facultatifs).</li>
        <li>Indique un budget et une date (optionnels).</li>
        <li>Clique <strong>Tirer au sort</strong> : la page g√©n√®re un tirage sans auto-attribution et respecte les exclusions.</li>
        <li>Copie les <strong>liens individuels</strong> et envoie-les. Rien n'est envoy√© √† un serveur.</li>
      </ol>
    </div>

    <div class="footer">‚ú® Joyeux No√´l ! ‚Äî Code 100% c√¥t√© client, sans pub ni traqueur.</div>
  </div>

  <div id="confetti" class="confetti"></div>

<script>
(function(){
  /* --- neige --- */
  const snow = document.getElementById('snow');
  for(let i=0;i<24;i++){
    const s=document.createElement('div'); s.className='snowflake';
    s.textContent=Math.random()<.5?'‚ùÑ':'‚ú∂';
    s.style.left=Math.random()*100+'vw';
    s.style.fontSize=(12+Math.random()*18)+'px';
    s.style.animationDuration=(8+Math.random()*12)+'s';
    s.style.setProperty('--x',(Math.random()*80-40)+'px');
    snow.appendChild(s);
  }

  /* --- donn√©es pr√©charg√©es --- */
  const preloadedParticipants = [
    {name:"Hubert", email:"h2marliave@gmail.com"},
    {name:"Alexandre", email:"alexandre.giuglaris@gmail.com"},
    {name:"Henri", email:"hdemarliave@gmail.com"},
    {name:"Louis", email:"louidemar@gmail.com"},
    {name:"Caroline", email:"tillieuxcaroline@gmail.com"},
    {name:"Marie-Caroline", email:"mcdemarliave@gmail.com"},
    {name:"Constance", email:"constancedemarliave@gmail.com"},
    {name:"Lucile", email:"luciledemarliave@gmail.com"}
  ];
  const hardExclusions = [
    ["Hubert","Marie-Caroline"],
    ["Alexandre","Constance"],
    ["Henri","Caroline"]
  ];

  /* --- helpers DOM --- */
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const els = {
    organizer: qs('#organizer'), participant: qs('#participant'),
    list: qs('#list'), draw: qs('#draw'), shuffle: qs('#shuffle'),
    results: qs('#results'), table: qs('#table'),
    title: qs('#title'), budget: qs('#budget'), date: qs('#date'),
    intro: qs('#intro'), slotStage: qs('#slotStage'), slotName: qs('#slotName'),
    slotStrip: qs('#slotStrip'), spinBtn: qs('#spinBtn'),
    final: qs('#final'), giftTo: qs('#giftTo'),
    pBack: qs('#pBack'), pEvent: qs('#pEvent'), pBudget: qs('#pBudget'),
    pDate: qs('#pDate'), rules: qs('#rules'), confetti: qs('#confetti')
  };
  const state = { participants:[], pairs:[], tokens:{}, payload:null };

  /* --- Audio --- */
  const jingle = new Audio("in-the-summer-we-just-had.mp3");
  jingle.volume = 0.4;
  jingle.preload = "auto";
  function playJingle(){
    jingle.currentTime = 0;
    jingle.play().catch(()=>{});
  }

  /* --- core functions abr√©g√©es --- */
  function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]];} return x; }

  /* --- Slot machine --- */
  function startSlot(names, target){
    const pool = names.filter(n=>n!==target);
    const seq = [];
    for(let i=0;i<18;i++) seq.push(pool[Math.floor(Math.random()*pool.length)]);
    seq.push(target);
    els.slotStrip.innerHTML='';
    seq.slice(0,6).forEach(n=>{
      const c=document.createElement('span'); c.className='slot-chip'; c.textContent=n; els.slotStrip.appendChild(c);
    });
    let idx=0, delay=60;
    function tick(){
      const name=seq[idx];
      els.slotName.textContent=name;
      if(idx<seq.length-1){
        els.slotStrip.removeChild(els.slotStrip.firstChild);
        const chip=document.createElement('span'); chip.className='slot-chip'; chip.textContent=seq[Math.min(idx+6,seq.length-1)];
        els.slotStrip.appendChild(chip);
      }
      idx++;
      if(idx<seq.length-1){
        delay = Math.min(260, delay + (idx>16? 30 : 10));
        setTimeout(tick, delay);
      }else{
        els.slotName.textContent=target;
        playJingle(); // üîî son au moment du r√©sultat
        burstConfetti();
        setTimeout(()=>{
          els.slotStage.style.display='none';
          els.final.style.display='grid';
          els.giftTo.textContent='üéÅ Tu offres √† ' + target + ' !';
        }, 400);
      }
    }
    tick();
  }

  function burstConfetti(){
    const colors=['#facc15','#e11d48','#22c55e','#60a5fa','#f472b6','#f97316'];
    for(let i=0;i<90;i++){
      const e=document.createElement('i');
      e.style.left=Math.random()*100+'vw'; e.style.top='0';
      e.style.background=colors[Math.floor(Math.random()*colors.length)];
      e.style.transform=`rotate(${Math.random()*360}deg)`;
      e.style.animationDelay=(Math.random()*0.6)+'s'; e.style.opacity=0.85;
      els.confetti.appendChild(e); setTimeout(()=>e.remove(), 2000);
    }
  }

  /* --- Reveal logique --- */
  function rebuildFromPayload(payloadStr, tokenKey){
    try{
      const data = JSON.parse(decodeURIComponent(atob(payloadStr)));
      const entry = (data.list||[]).find(x=>x.t===tokenKey);
      if(!entry) return null;
      return {meta:data, me:entry.g, to:entry.r};
    }catch(e){ return null; }
  }

  function activateParticipant(meta, me, to){
    els.pEvent.textContent = meta.ev ? 'üéâ '+meta.ev : '';
    els.pBudget.textContent = meta.bu ? 'üí∂ Budget : '+meta.bu : '';
    els.pDate.textContent = meta.dt ? 'üìÖ √âchange : '+meta.dt : '';

    const allNames = (meta.list||[]).map(x=>x.g);
    els.startReveal.onclick = ()=>{
      els.intro.style.display='none';
      els.slotStage.style.display='grid';
      els.spinBtn.disabled = false;
      playJingle(); // üîä joue au lancement du d√©filement
      els.spinBtn.onclick = ()=>{
        els.spinBtn.disabled = true;
        startSlot(allNames, to);
      };
    };
  }

  function handleHash(){
    const u=new URLSearchParams(location.hash.slice(1));
    const d=u.get('d'), t=u.get('t');
    if(d && t){
      els.organizer.style.display='none';
      els.participant.style.display='';
      const parsed=rebuildFromPayload(d,t);
      if(parsed){ activateParticipant(parsed.meta, parsed.me, parsed.to); }
      return;
    }
    els.organizer.style.display='';
    els.participant.style.display='none';
  }

  /* --- init --- */
  handleHash();
  window.addEventListener('hashchange', handleHash);
})();
</script>
</body>
</html>
